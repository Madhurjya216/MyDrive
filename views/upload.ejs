<!-- views/upload.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload File</title>
   <link rel="icon" href="https://i.ibb.co/FL4fpDwF/1742348862365-781564657.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f5f5f5; }
    .container { max-width:800px; margin:50px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .upload-area { border:2px dashed #ddd; border-radius:8px; padding:30px; text-align:center; cursor:pointer; transition:all .2s; }
    .upload-area:hover { border-color:#4285F4; background:#f6fbff; }
    .upload-btn { background:#4285F4; color:#fff; padding:12px 25px; border-radius:6px; border:none; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    .form-row { display:flex; gap:16px; align-items:center; margin-top:12px; }
    label.visibility { display:flex; gap:8px; align-items:center; font-weight:500; color:#333; }
    .file-preview { margin-top:20px; display:none; }
    .file-list { margin-top:10px; }
    .file-item { display:flex; align-items:center; gap:10px; padding:8px; background:#f5f5f5; border-radius:4px; margin-bottom:8px; }
    .file-item i { color:#4285F4; }
    .file-item .remove-btn { margin-left:auto; cursor:pointer; color:#d32f2f; }
    .file-info { margin-top:10px; color:#555; }
    .error { background:#ffebee; border-left:4px solid #d32f2f; color:#d32f2f; padding:12px; border-radius:4px; margin-bottom:12px; }
    .back-link { color:#4285F4; text-decoration:none; }
    .file-size-warning { display:none; color:#ff9800; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Upload Files</h1>
      <a href="/dashboard" class="back-link"><i class="fas fa-arrow-left"></i> Back to dashboard</a>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="error"><i class="fas fa-exclamation-circle"></i> <%= error %></div>
    <% } %>

    <form id="uploadForm" action="/document/upload" method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label for="files">Select files to upload (max 20 files)</label>
        <div id="uploadArea" class="upload-area">
          <i class="fas fa-cloud-upload-alt" style="font-size:48px;color:#4285F4"></i>
          <div class="upload-text">Drag and drop files here or click to browse</div>
          <div class="upload-text">Max file size: 16MB per file</div>
        </div>
        <!-- FIXED: Added 'multiple' attribute and changed name to 'files' -->
        <input type="file" name="files" multiple id="fileInput" style="display:none" required />
        <div class="file-size-warning" id="fileSizeWarning">
          <i class="fas fa-exclamation-triangle"></i> Large files may take longer to upload
        </div>
      </div>

      <!-- Visibility Options -->
      <div class="form-row">
        <div>
          <div style="font-weight:600;margin-bottom:6px;">Visibility</div>
          <label class="visibility">
            <input type="radio" name="visibility" value="private" checked /> Private
          </label>
          <label class="visibility" style="margin-left:12px;">
            <input type="radio" name="visibility" value="public" /> Public
          </label>
        </div>
      </div>

      <!-- File Preview List -->
      <div class="file-preview" id="filePreview">
        <h3>Selected Files (<span id="fileCount">0</span>):</h3>
        <div class="file-list" id="fileList"></div>
      </div>

      <div style="margin-top:18px;">
        <button type="submit" id="uploadBtn" class="upload-btn">
          <i class="fas fa-upload"></i> Upload Files
        </button>
      </div>
    </form>
  </div>

  <script>
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");
    const fileList = document.getElementById("fileList");
    const fileCount = document.getElementById("fileCount");
    const uploadForm = document.getElementById("uploadForm");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileSizeWarning = document.getElementById("fileSizeWarning");

    let selectedFiles = [];

    uploadArea.addEventListener("click", () => fileInput.click());

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "#4285F4";
      uploadArea.style.backgroundColor = "#f1f8ff";
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.style.borderColor = "#ddd";
      uploadArea.style.backgroundColor = "transparent";
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "#ddd";
      uploadArea.style.backgroundColor = "transparent";
      if (e.dataTransfer.files.length) {
        handleFiles(e.dataTransfer.files);
      }
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files.length) {
        handleFiles(fileInput.files);
      }
    });

    function handleFiles(files) {
      selectedFiles = Array.from(files);
      
      // Limit to 20 files
      if (selectedFiles.length > 20) {
        alert("Maximum 20 files allowed!");
        selectedFiles = selectedFiles.slice(0, 20);
      }

      displayFiles();
      
      // Check for large files
      const hasLargeFiles = selectedFiles.some(f => f.size > 5 * 1024 * 1024);
      fileSizeWarning.style.display = hasLargeFiles ? "block" : "none";
    }

    function displayFiles() {
      fileList.innerHTML = "";
      fileCount.textContent = selectedFiles.length;
      
      if (selectedFiles.length === 0) {
        filePreview.style.display = "none";
        return;
      }

      filePreview.style.display = "block";

      selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        
        const icon = getFileIcon(file.type);
        const size = formatFileSize(file.size);
        
        fileItem.innerHTML = `
          <i class="fas ${icon}"></i>
          <span style="flex:1;">${file.name}</span>
          <span style="color:#666;font-size:12px;">${size}</span>
          <i class="fas fa-times remove-btn" onclick="removeFile(${index})"></i>
        `;
        
        fileList.appendChild(fileItem);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      
      // Update file input
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
      
      displayFiles();
    }

    function getFileIcon(mimetype) {
      if (mimetype.startsWith("image/")) return "fa-file-image";
      if (mimetype.startsWith("video/")) return "fa-file-video";
      if (mimetype.startsWith("audio/")) return "fa-file-audio";
      if (mimetype === "application/pdf") return "fa-file-pdf";
      if (mimetype.includes("word")) return "fa-file-word";
      if (mimetype.includes("excel") || mimetype.includes("spreadsheet")) return "fa-file-excel";
      return "fa-file";
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + " bytes";
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
      else return (bytes / 1048576).toFixed(1) + " MB";
    }

    uploadForm.addEventListener("submit", function(e) {
      e.preventDefault();
      
      if (selectedFiles.length === 0) {
        return alert("Please select at least one file to upload.");
      }

      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

      const formData = new FormData();
      
      // Add all files
      selectedFiles.forEach((file) => {
        formData.append("files", file);
      });

      // Add visibility
      const vis = document.querySelector('input[name="visibility"]:checked');
      const visibilityValue = vis ? vis.value : "private";
      formData.append("visibility", visibilityValue);

      // AJAX upload with progress
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener("progress", (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          uploadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Uploading ${percent}%`;
        }
      });

      xhr.addEventListener("load", () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const res = JSON.parse(xhr.responseText);
            if (res.success && res.redirect) {
              window.location.href = res.redirect;
            } else {
              window.location.href = "/dashboard";
            }
          } catch (err) {
            window.location.href = "/dashboard";
          }
        } else {
          alert("Upload failed. Try again.");
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Files';
        }
      });

      xhr.addEventListener("error", () => {
        alert("Network error. Try again.");
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Files';
      });

      xhr.open("POST", "/document/upload", true);
      xhr.timeout = 300000; // 5 minutes
      xhr.send(formData);
    });
  </script>
</body>
</html>